<div class="modal-overlay" *ngIf="showShareModal">
  <div class="share-modal">
    <div style="display: flex; flex-direction: row">
      <h2 style="width: 95%">Share "{{ document?.name }}"</h2>
      <button class="close-share-btn" (click)="closeShareModal()">√ó</button>
    </div>
    <!-- Leva strana: forma za dodavanje -->
    <div class="form-section">
      <div class="form-group">
        <label for="principalType">Share with:</label>
        <select
          id="principalType"
          [(ngModel)]="principalType"
          (change)="onPrincipalChange()"
        >
          <option value="user">User</option>
          <option value="group">User Group</option>
        </select>
      </div>

      <div class="form-group" *ngIf="principalType === 'user'">
        <label for="userEmail">User Email:</label>
        <input
          id="userEmail"
          type="email"
          [(ngModel)]="email"
          placeholder="Enter user email"
        />
      </div>

      <div class="form-group" *ngIf="principalType === 'group'">
        <label for="groupName">User Group:</label>
        <select id="groupName" [(ngModel)]="selectedGroup">
          <option *ngFor="let g of groups" [value]="g.name">
            {{ g.name }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="accessType">Access Type:</label>
        <select id="accessType" [(ngModel)]="accessType">
          <option value="PREVIEW">Preview</option>
          <option value="VIEWER">Viewer</option>
          <option value="EDITOR">Editor</option>
        </select>
      </div>

      <div class="expiration-section">
        <label>
          <input type="checkbox" [(ngModel)]="hasExpiration" />
          <span>Expiration</span>
        </label>

        <input
          *ngIf="hasExpiration"
          type="datetime-local"
          [(ngModel)]="expiresAt"
          class="datetime-picker"
        />
      </div>

      <div class="modal-footer3">
        <button class="cancel-btn" (click)="closeShareModal()">Cancel</button>
        <button
          class="share-btn"
          [disabled]="!canShare()"
          (click)="sharePermission()"
        >
          Share
        </button>
      </div>

      <!-- Desna strana: lista postojeƒáih permission-a -->
      <div>
        <h3 style="font-weight: 500">Shared With</h3>
        <div class="permissions-section">
          <div
            class="permission-card"
            *ngFor="let perm of document!.permissions"
          >
            <div style="display: flex; flex-direction: row">
              <div style="width: 90%">
                <div class="perm-field">
                  <p class="perm-principal">
                    <strong>{{ perm.user_email || perm.group_name }}</strong>
                  </p>
                  <select [(ngModel)]="perm.permission_value.access_type">
                    <option value="PREVIEW">Preview</option>
                    <option value="VIEWER">Viewer</option>
                    <option value="EDITOR">Editor</option>
                  </select>
                </div>

                <div class="perm-field">
                  <label>
                    <input
                      type="checkbox"
                      [(ngModel)]="perm.permission_value.expires_at"
                      (change)="toggleExpiration(perm)"
                    />
                    Expiration
                  </label>
                  <input
                    *ngIf="perm.permission_value.expires_at"
                    type="datetime-local"
                    [(ngModel)]="perm.permission_value.expires_at"
                  />
                </div>
              </div>
              <mat-icon
                style="font-size: 30px; margin-top: 20px; margin-left: 10px"
                >delete</mat-icon
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-container">
  <div class="top-bar">
    <div
      *ngIf="!isUpdating && document?.access_type == 'EDITOR'"
      style="display: flex; flex-direction: row"
    >
      <div class="section-item add-meta" (click)="startUpdate()">
        <span class="icon">‚öôÔ∏è</span>
        <!-- ili neki emoji po izboru -->
        <span class="label">Modify</span>
      </div>
      <div class="section-item add-meta" (click)="openShareModal()">
        <span class="icon">üîÅ</span>
        <!-- ili neki emoji po izboru -->
        <span class="label">Share</span>
      </div>
      <div class="section-item add-meta" (click)="openModal()">
        <span class="icon">‚åõ</span>
        <!-- ili neki emoji po izboru -->
        <span class="label">Retention</span>
      </div>
      <!-- <div class="section-item add-meta" (click)="openModal()">
        <span class="icon">üóÇÔ∏è</span>
        <span class="label">Move</span>
      </div> -->
      <div class="section-item add-meta" (click)="deleteDocument()">
        <span class="icon">üóëÔ∏è</span>
        <!-- ili neki emoji po izboru -->
        <span class="label">Delete</span>
      </div>
    </div>
    <button
      *ngIf="!isUpdating && document?.access_type == 'EDITOR'"
      class="upload-button"
      (click)="toggleUpload()"
    >
      Upload New Version
      <span class="arrow">
        {{ isUploadOpen ? "‚ñ≤" : "‚ñº" }}
      </span>
    </button>
    <xp-search-bar *ngIf="!isUpdating" class="search-bar"></xp-search-bar>
    <xp-search-bar
      *ngIf="isUpdating"
      class="search-bar-correct"
    ></xp-search-bar>
  </div>

  <div class="main-content">
    <!-- Breadcrumb -->
    <div class="breadcrumb-container">
      <div class="breadcrumb" style="margin-top: 20px; margin-left: 10px">
        <ng-container *ngFor="let item of document?.path; let last = last">
          <a
            *ngIf="!last"
            [routerLink]="['/document-management/directory', item.id]"
            class="breadcrumb-link"
            style="font-size: larger"
          >
            {{ item.name }}
          </a>
          <span
            *ngIf="last"
            class="breadcrumb-current"
            style="font-size: larger"
          >
            {{ item.name }}
          </span>
          <span *ngIf="!last" style="font-size: larger"> > </span>
        </ng-container>
      </div>
      <div *ngIf="!isUpdating">
        <div
          class="upload-panel-1"
          *ngIf="isUploadOpen && !isUploading"
          (click)="fileInput.click()"
          (dragover)="onDragOver($event)"
          (drop)="onDrop($event)"
        >
          <p>Click or drag new document version here</p>
          <input
            type="file"
            #fileInput
            hidden
            (change)="onFileSelected($event)"
          />
        </div>
        <div class="upload-section" *ngIf="isUploadOpen && isUploading">
          <!-- Upload panel levo -->
          <div
            class="upload-panel"
            (click)="fileInput.click()"
            (dragover)="onDragOver($event)"
            (drop)="onDrop($event)"
          >
            <p>Click or drag document here</p>
            <input
              type="file"
              #fileInput
              hidden
              (change)="onFileSelected($event)"
            />
          </div>

          <!-- Lista fajlova desno -->
          <div class="upload-list">
            <div class="upload-item" *ngFor="let upload of uploads">
              <div class="upload-name">{{ upload.file.name }}</div>
              <div class="upload-status">
                <ng-container *ngIf="upload.status === 'Uploading...'">
                  <div class="progress-bar">
                    <div
                      class="progress-fill"
                      [style.width.%]="upload.progress"
                    ></div>
                  </div>
                  <span>{{ upload.progress }}%</span>
                </ng-container>
                <ng-container *ngIf="upload.status === 'Done'">
                  ‚úÖ Done
                </ng-container>
                <ng-container *ngIf="upload.status !== 'Done'">
                  <span style="color: rgb(211, 117, 117)">
                    ‚ùå {{ upload.status }}
                  </span>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
        <div class="document-preview-section" *ngIf="document">
          <div class="document-left">
            <div class="document-thumbnail" (click)="openPreview()">üìÑ</div>

            <div class="document-info">
              <div class="document-info-header">
                <h3
                  style="
                    width: 200px;
                    max-width: 200px;
                    white-space: normal;
                    word-wrap: break-word;
                    overflow-wrap: anywhere;
                  "
                  (click)="openPreview()"
                >
                  {{ document.name }}
                </h3>
                <div style="margin-left: 30px; max-width: 800px">
                  <div style="display: flex; flex-direction: row">
                    <h2>Summary</h2>
                    <button
                      class="edit-summary-button"
                      *ngIf="activeVersion.summary && document?.access_type"
                      (click)="addSummary()"
                    >
                      Edit Summary
                    </button>
                  </div>
                  <p class="document-summary" *ngIf="activeVersion.summary">
                    {{
                      (activeVersion.summary | slice : 0 : 269) +
                        (activeVersion.summary.length > 269 ? "..." : "")
                    }}
                  </p>

                  <button
                    class="add-summary-button"
                    *ngIf="!activeVersion.summary && document?.access_type"
                    (click)="addSummary()"
                  >
                    Add summary
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Tagovi ispod -->

          <h2 style="width: 100px">Tags</h2>
          <div class="tags">
            <span *ngFor="let tag of document?.tags" class="tag">{{
              tag.name
            }}</span>
          </div>

          <!-- Ostali meta podaci -->
          <div class="document-meta">
            <div class="document-meta-grid">
              <div style="width: 50em; display: flex; flex-direction: column">
                <span><strong>Creator:</strong> {{ document.creator }}</span>
                <span style="margin-top: 10px"
                  ><strong>Created At:</strong>
                  {{ document.created_at | date : "short" }}</span
                >
              </div>
              <div style="width: 50em; display: flex; flex-direction: column">
                <span
                  ><strong>Last modified:</strong>
                  {{ document.last_modified | date : "short" }}</span
                >
                <span style="margin-top: 10px"
                  ><strong>Size:</strong>
                  {{ formatFileSize(activeVersion.file_size) }}</span
                >
              </div>
              <!-- <div style="width: 40em; display: flex; flex-direction: column">
                <button class="lock-button">Lock Document</button>
              </div> -->
            </div>

            <div
              style="margin-top: 10px"
              *ngFor="let meta of document?.custom_metadata_values"
            >
              <strong>{{ meta.custom_metadata.name }}:</strong>

              <span
                style="color: red"
                *ngIf="meta.is_missing_value; else showValue"
              >
                *missing a value*
              </span>

              <ng-template #showValue>
                <ng-container [ngSwitch]="meta.custom_metadata.metadata_type">
                  <span *ngSwitchCase="'String'">{{ meta.value }}</span>
                  <span *ngSwitchCase="'Boolean'">{{
                    meta.value === true ? "Yes" : "No"
                  }}</span>
                  <span *ngSwitchCase="'Integer'">{{ meta.value }}</span>
                  <span *ngSwitchCase="'Decimal'">{{ meta.value }}</span>
                  <span *ngSwitchCase="'Date'">{{
                    meta.value | date : "yyyy-MM-dd"
                  }}</span>
                  <span *ngSwitchCase="'Datetime'">{{
                    meta.value | date : "yyyy-MM-dd HH:mm:ss"
                  }}</span>
                  <span *ngSwitchCase="'Time'">{{ meta.value }}</span>
                  <span *ngSwitchDefault>{{ meta.value }}</span>
                </ng-container>
              </ng-template>
            </div>
          </div>
        </div>

        <div class="preview-modal2" *ngIf="showSummaryModal">
          <div class="modal2">
            <div class="modal-header2">
              <button class="generate-btn2" (click)="generateSummary()">
                {{ isLoading ? "Generating..." : "Generate ‚ú®" }}
              </button>

              <h1 style="margin-left: 350px; font-weight: 500">Summary</h1>
            </div>

            <div class="modal-body2">
              <textarea
                class="modal-textarea2"
                [(ngModel)]="summaryText"
                (input)="updateCharCount()"
                maxlength="2000"
                placeholder="Enter your summary here..."
              ></textarea>

              <div class="char-counter2">{{ charCount }}/2000</div>
            </div>

            <div class="modal-footer2">
              <button class="cancel-btn2" (click)="closeSummaryModal()">
                CANCEL
              </button>
              <button
                class="save-btn2"
                [disabled]="!summaryText.trim()"
                (click)="saveSummary()"
              >
                SAVE
              </button>
            </div>
            <div *ngIf="isLoading" class="loader-overlay">
              <div class="spinner"></div>
              <p>Generating summary...</p>
            </div>
          </div>
        </div>

        <div
          class="preview-modal"
          *ngIf="isPreviewOpen"
          (click)="closePreview()"
        >
          <div class="preview-content" (click)="$event.stopPropagation()">
            <h3>{{ document?.name }}</h3>

            <img
              *ngIf="
                activeVersion.file_type.endsWith('.jpg') ||
                activeVersion.file_type.endsWith('.png') ||
                activeVersion.file_type.endsWith('.jpeg')
              "
              [src]="fileUrl"
              style="max-width: 100%; max-height: 600px"
            />

            <!-- Tekstualni fajl -->
            <ng-container
              *ngIf="
                activeVersion.file_type === '.txt' ||
                activeVersion.file_type === '.csv'
              "
            >
              <pre
                style="
                  max-height: 600px;
                  min-height: 0;
                  overflow: auto;
                  background-color: #f9f9f9;
                  padding: 10px;
                  border-radius: 8px;
                  font-family: 'Courier New', monospace;
                  white-space: pre-wrap;
                "
                >{{ fileText | slice : 0 : 10000 }}
  </pre
              >
            </ng-container>

            <!-- Fallback -->
            <!-- <button
              *ngIf="
                !activeVersion.file_type.endsWith('.txt') &&
                !activeVersion.file_type.endsWith('.csv') &&
                !activeVersion.file_type.endsWith('.jpg') &&
                !activeVersion.file_type.endsWith('.jpeg') &&
                !activeVersion.file_type.endsWith('.png')
              "
              (click)="openInNewTab()"
            >
              Open file in new tab
            </button> -->

            <!-- Fallback download -->
            <a
              style="width: 95px"
              *ngIf="
                activeVersion.file_type.endsWith('.jpg') ||
                activeVersion.file_type.endsWith('.png') ||
                activeVersion.file_type.endsWith('.jpeg') ||
                activeVersion.file_type.endsWith('.csv') ||
                activeVersion.file_type === '.txt'
              "
              [href]="fileUrl"
              target="_blank"
              download="{{ activeVersion.file_name }}"
            >
              Download file
            </a>

            <button style="margin-top: -30px" (click)="closePreview()">
              Close
            </button>
          </div>
        </div>

        <!-- Table -->
        <h2 style="margin-left: 20px; margin-top: 30px; color: green">
          Document Versions
        </h2>
        <table class="metadata-table">
          <thead>
            <tr>
              <th>Uploaded</th>
              <th>Uploaded By</th>
              <th>File Name</th>
              <th>Version</th>
              <th>Restore</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let version of document?.document_files; let i = index"
              [class.odd]="i % 2 === 1"
              [class.even]="i % 2 === 0"
            >
              <td>{{ version.uploaded_at | date : "short" }}</td>
              <td>{{ version.uploader }}</td>
              <td>{{ version.file_name }}</td>
              <td>{{ version.version }}</td>
              <td>
                <mat-icon
                  *ngIf="version.version !== document?.active_version"
                  style="cursor: pointer"
                  (click)="restoreVersion(version.version)"
                  >restore</mat-icon
                >
                <p
                  *ngIf="version.version === document?.active_version"
                  style="color: green; font-weight: 600"
                >
                  Active
                </p>
              </td>
              <td class="actions-cell">
                <mat-icon>download</mat-icon>
                <mat-icon style="margin-left: 10px">delete</mat-icon>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="document-preview-section" *ngIf="isUpdating">
        <div class="document-left">
          <div class="document-thumbnail">üìÑ</div>

          <div class="document-info">
            <div class="document-info-header editable-name">
              <!-- Input za menjanje imena -->
              <input
                placeholder="Enter document name"
                type="text"
                [(ngModel)]="updateName"
                class="name-input"
              />

              <!-- Ekstenzija desno -->
              <span class="extension">{{ activeVersion!.file_type }}</span>
            </div>
            <p style="color: red; margin-top: 10px">{{ updateError }}</p>
          </div>
        </div>

        <!-- Tagovi ispod -->

        <h2 style="margin-top: 20px; margin-bottom: 0px; color: green">Tags</h2>
        <div class="tags-input-container">
          <!-- Veƒá postojeƒái tagovi -->
          <div class="tag" *ngFor="let tag of updateTags; let i = index">
            {{ tag.name }}
            <span class="remove-tag" (click)="removeTag(i)">√ó</span>
          </div>

          <!-- Input za unos -->
          <input
            type="text"
            [(ngModel)]="tagInput"
            (keydown.enter)="addTagFromInput($event)"
            (keydown.backspace)="handleBackspace($event)"
            (input)="filterTags()"
            [placeholder]="updateTags.length === 0 ? 'Add tags...' : ''"
          />

          <!-- Dropdown preporuka -->
          <ul class="suggestions" *ngIf="filteredTags.length > 0">
            <li
              *ngFor="let suggestion of filteredTags"
              (mousedown)="selectSuggestion(suggestion)"
            >
              {{ suggestion.name }}
            </li>
          </ul>
        </div>

        <!-- Ostali meta podaci -->
        <div class="document-meta">
          <div class="document-meta-grid">
            <div style="width: 30em; display: flex; flex-direction: column">
              <span><strong>Creator:</strong> {{ document?.creator }}</span>
              <span style="margin-top: 10px"
                ><strong>Created At:</strong>
                {{ document?.created_at | date : "short" }}</span
              >
            </div>
            <div style="width: 30em; display: flex; flex-direction: column">
              <span
                ><strong>Last modified:</strong>
                {{ document?.last_modified | date : "short" }}</span
              >
              <span style="margin-top: 10px"
                ><strong>Size:</strong>
                {{ formatFileSize(activeVersion.file_size) }}</span
              >
            </div>
          </div>
          <h2 class="custom-metadata-title">Custom Metadata</h2>

          <div
            class="metadata-item"
            *ngFor="let meta of updateMetadata; let i = index"
          >
            <label>{{ meta.custom_metadata.name }}:</label>

            <!-- String -->
            <input
              *ngIf="meta.custom_metadata.metadata_type === 'String'"
              type="text"
              [(ngModel)]="meta.value"
            />

            <!-- Boolean -->
            <input
              *ngIf="meta.custom_metadata.metadata_type === 'Boolean'"
              type="checkbox"
              [(ngModel)]="meta.value"
            />

            <!-- Date -->
            <input
              *ngIf="meta.custom_metadata.metadata_type === 'Date'"
              type="date"
              [(ngModel)]="meta.value"
            />

            <!-- Datetime -->
            <input
              *ngIf="meta.custom_metadata.metadata_type === 'Datetime'"
              type="datetime-local"
              [(ngModel)]="meta.value"
            />

            <!-- Time -->
            <input
              *ngIf="meta.custom_metadata.metadata_type === 'Time'"
              type="time"
              [(ngModel)]="meta.value"
              step="1"
            />

            <!-- Integer -->
            <input
              *ngIf="meta.custom_metadata.metadata_type === 'Integer'"
              type="number"
              step="1"
              [(ngModel)]="meta.value"
            />

            <!-- Decimal -->
            <input
              *ngIf="meta.custom_metadata.metadata_type === 'Decimal'"
              type="number"
              step="0.01"
              [(ngModel)]="meta.value"
            />

            <!-- Dugme za uklanjanje -->
            <button class="remove-btn" (click)="removeMetadata(i)">√ó</button>
          </div>

          <!-- Dodavanje novih metadata -->
          <div class="metadata-add">
            <select [(ngModel)]="selectedMetadataId">
              <option [ngValue]="null">-- Add metadata --</option>
              <option
                *ngFor="let meta of allMetadata"
                [ngValue]="meta.id"
                [disabled]="isMetadataDisabled(meta.id)"
              >
                {{ meta.name }}
              </option>
            </select>
            <button
              [disabled]="!selectedMetadataId"
              class="metadata-add-button"
              (click)="addMetadata()"
            >
              Add
            </button>
            <div style="margin-left: 630px">
              <button (click)="cancelUpdate()" class="cancel-update-button">
                CANCEL
              </button>
              <button (click)="saveUpdate()" class="save-update-button">
                SAVE
              </button>
            </div>
          </div>
        </div>
      </div>
      <!--
<div class="modal-backdrop" *ngIf="isModalOpen" (click)="closeModal()"></div>

<div class="modal" *ngIf="isModalOpen">
  <div class="modal-header">
    <h3>New Directory</h3>
    <span class="close-btn" (click)="closeModal()">√ó</span>
  </div>
  <div class="modal-body">
    <input
      type="text"
      [(ngModel)]="newDirectoryName"
      placeholder="Directory Name"
    />
    <p
      style="position: absolute; color: red; margin-left: 5px; margin-top: 2px"
    >
      {{ errorMessage }}
    </p>
  </div>
  <div class="modal-footer">
    <button class="create-btn" (click)="createDirectory()">CREATE</button>
  </div>
</div> -->
    </div>
  </div>
</div>
