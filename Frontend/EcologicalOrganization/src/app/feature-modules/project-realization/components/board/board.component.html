<div class="board-toolbar" *ngIf="!isArchived">
  <button
    type="button"
    class="btn-primary"
    *ngIf="!isArchived"
    (click)="startAddStatus($event)"
  >
    + Add status
  </button>
</div>

<div class="board-scroll">
  <div class="board" #boardRef>
    <!-- KOLONE (statusi) -->
    <section class="column" *ngFor="let s of statuses">
      <header class="col-head">
        <div class="col-title">{{ s.name }}</div>
        <button class="icon-btn" aria-label="Column menu">⋯</button>
      </header>

      <!-- KARTICE (taskovi) -->
      <article
        class="card"
        *ngFor="let t of tasksFor(s.id!)"
        (click)="openTask(t)"
        tabindex="0"
      >
        <div class="card-title">{{ t.name }}</div>

        <!-- Assignee iz members mape -->
        <!-- Assignee (lepši badge) -->
        <ng-container *ngIf="assigneeFor(t) as m; else noAssignee">
          <div class="assignee-badge">
            <span class="av">{{ initialsFrom(m) }}</span>
            <div class="meta">
              <div class="name">User #{{ m.userId }}</div>
              <div class="role">{{ roleLabel(m.roleInProject) }}</div>
            </div>
          </div>
        </ng-container>
        <ng-template #noAssignee>
          <div class="assignee-badge ghost">
            <span class="av av-ghost">∅</span>
            <div class="meta">
              <div class="name muted">No assignee</div>
              <div class="role">—</div>
            </div>
          </div>
        </ng-template>

        <div class="due">
          <span class="ic" aria-hidden="true">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <rect
                x="3"
                y="5"
                width="18"
                height="16"
                rx="2"
                stroke="currentColor"
              />
              <path d="M3 9h18" stroke="currentColor" />
            </svg>
          </span>
          <span>{{ t.deadline ? (t.deadline | date : "d-MMM-y") : "—" }}</span>
        </div>

        <footer class="card-foot">
          <span class="muted small" title="Comments">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              style="vertical-align: -2px; margin-right: 4px"
              aria-hidden="true"
            >
              <!-- balon: zaobljeni pravougaonik -->
              <rect
                x="3"
                y="5"
                width="18"
                height="12"
                rx="3"
                stroke="currentColor"
                stroke-width="1.6"
                fill="none"
              />
              <!-- repić (izlazi iz donje ivice) -->
              <path
                d="M9 17 L6 20 V17"
                stroke="currentColor"
                stroke-width="1.6"
                fill="none"
                stroke-linejoin="round"
                stroke-linecap="round"
              />
            </svg>
            {{ commentCounts.get(t.id) ?? 0 }}
          </span>
        </footer>
      </article>

      <!-- EDITOR (prazna kartica) -->
      <article
        class="card editor"
        *ngIf="!isArchived && ui.get(s.id!)?.adding"
        (click)="$event.stopPropagation()"
      >
        <!-- Task name -->
        <input
          class="task-input"
          placeholder="Task name"
          [(ngModel)]="ui.get(s.id!)!.draftName"
        />

        <!-- Assignee -->
        <div class="assignee-field">
          <button
            class="select"
            type="button"
            (click)="toggleAssignee(s.id!, $event)"
          >
            <ng-container
              *ngIf="
                ui.get(s.id!)?.draftAssignee as mem;
                else assigneePlaceholder
              "
            >
              {{ displayName(mem) }}
              <span class="muted" style="margin-left: 6px"
                >· {{ roleLabel(mem.roleInProject) }}</span
              >
            </ng-container>
            <ng-template #assigneePlaceholder>
              <span class="muted">Assign user</span>
            </ng-template>
            <span class="caret">▾</span>
          </button>

          <div
            class="assignee-menu"
            *ngIf="ui.get(s.id!)?.assigneeOpen"
            (click)="$event.stopPropagation()"
            (wheel)="$event.stopPropagation()"
          >
            <button
              class="assignee-item"
              *ngFor="let m of members"
              (click)="pickAssignee(s.id!, m)"
            >
              <span class="avatar sm">{{ (m.userId + "")?.slice(-1) }}</span>
              <div>
                <div class="assignee-name">User #{{ m.userId }}</div>
                <div class="assignee-role">
                  {{ roleLabel(m.roleInProject) }}
                </div>
              </div>
            </button>
          </div>
        </div>

        <!-- Due date -->
        <div class="date-field">
          <input
            #due
            type="date"
            class="date-input"
            [value]="ui.get(s.id!)?.draftDue ?? ''"
            (change)="onDueChange(s.id!, due.value)"
          />
        </div>
      </article>

      <!-- Add task (samo ako nije terminalni status) -->
      <button
        class="add-task"
        *ngIf="!isTerminal(s) && !ui.get(s.id!)?.adding && !isArchived"
        type="button"
        (click)="startAdd(s.id!, $event)"
      >
        + Add task
      </button>
    </section>

    <!-- KOLONA ZA NOVI STATUS -->
    <section
      class="column status-editor"
      *ngIf="addingStatus"
      (click)="$event.stopPropagation()"
    >
      <header class="col-head">
        <div class="col-title">New status</div>
      </header>

      <input
        #newStatusInput
        class="status-input"
        placeholder="Status name"
        [(ngModel)]="draftStatusName"
        (keydown.enter)="commitAddStatus()"
      />

      <div class="muted small">Enter to save · click outside to cancel</div>
    </section>
  </div>

  <!-- TASK DRAWER -->
  <xp-task-drawer
    *ngIf="drawerOpen && selectedTask"
    [task]="selectedTask!"
    [members]="members"
    (close)="closeDrawer()"
    (updated)="onDrawerUpdated($event)"
  ></xp-task-drawer>
</div>
